<!-- views/products/details.ejs -->
<section class="product-details">
    <div class="container">
      <div class="breadcrumbs">
        <a href="/">Home</a> &gt;
        <a href="/products">Products</a> &gt;
        <a href="/products?category=<%= product.category %>">
          <% if (product.category === 'giftcard') { %>
            Gift Cards
          <% } else if (product.category === 'account') { %>
            Accounts
          <% } else if (product.category === 'currency') { %>
            Digital Currency
          <% } else { %>
            Other
          <% } %>
        </a> &gt;
        <span><%= product.name %></span>
      </div>
      
      <div class="product-content">
        <div class="product-gallery">
          <div class="main-image">
            <img src="<%= product.imageUrl %>" alt="<%= product.name %>">
          </div>
        </div>
        
        <div class="product-info">
          <h1 class="product-title"><%= product.name %></h1>
          
          <div class="product-meta">
            <div class="product-price">$<%= product.price.toFixed(2) %></div>
            
            <div class="product-rating">
              <% if (reviews.length > 0) { %>
                <div class="stars">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <% if (i <= Math.floor(avgRating)) { %>
                      <i class="fas fa-star"></i>
                    <% } else if (i - 0.5 <= avgRating) { %>
                      <i class="fas fa-star-half-alt"></i>
                    <% } else { %>
                      <i class="far fa-star"></i>
                    <% } %>
                  <% } %>
                </div>
                <span><%= avgRating %> (<%= reviews.length %> reviews)</span>
              <% } else { %>
                <span>No reviews yet</span>
              <% } %>
            </div>
          </div>
          
          <div class="product-stock">
            <% if (product.stock > 10) { %>
              <span class="in-stock">In Stock</span>
            <% } else if (product.stock > 0) { %>
              <span class="low-stock">Only <%= product.stock %> left!</span>
            <% } else { %>
              <span class="out-of-stock">Out of Stock</span>
            <% } %>
          </div>
          
          <div class="product-description">
            <h3>Description</h3>
            <p><%= product.description %></p>
          </div>
          
          <% if (product.stock > 0) { %>
            <form action="/cart/add" method="POST" class="add-to-cart-form">
              <div class="quantity-control">
                <label for="quantity">Quantity:</label>
                <div class="quantity-buttons">
                  <button type="button" class="qty-btn minus">-</button>
                  <input type="number" name="quantity" id="quantity" value="1" min="1" max="<%= product.stock %>">
                  <button type="button" class="qty-btn plus">+</button>
                </div>
              </div>
              
              <input type="hidden" name="productId" value="<%= product._id %>">
              <button type="submit" class="btn btn-primary btn-lg">Add to Cart</button>
            </form>
          <% } else { %>
            <button class="btn btn-disabled btn-lg" disabled>Out of Stock</button>
          <% } %>
          
          <div class="product-meta-info">
            <div class="meta-item">
              <i class="fas fa-shield-alt"></i>
              <span>Secure Payment</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-bolt"></i>
              <span>Instant Delivery</span>
            </div>
            <div class="meta-item">
              <i class="fas fa-headset"></i>
              <span>24/7 Support</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="product-tabs">
        <div class="tabs-header">
          <button class="tab-btn active" data-tab="reviews">Reviews (<%= reviews.length %>)</button>
        </div>
        
        <div class="tab-content active" id="reviews">
          <% if (reviews.length === 0) { %>
            <p class="no-reviews">No reviews yet. Be the first to review this product!</p>
          <% } else { %>
            <div class="reviews-list">
              <% reviews.forEach(review => { %>
                <div class="review-item">
                  <div class="review-header">
                    <div class="review-user">
                      <i class="fas fa-user-circle"></i>
                      <span><%= review.user.name %></span>
                    </div>
                    <div class="review-date">
                      <%= new Date(review.createdAt).toLocaleDateString() %>
                    </div>
                  </div>
                  
                  <div class="review-rating">
                    <% for (let i = 1; i <= 5; i++) { %>
                      <i class="<%= i <= review.rating ? 'fas' : 'far' %> fa-star"></i>
                    <% } %>
                  </div>
                  
                  <div class="review-content">
                    <p><%= review.comment %></p>
                  </div>
                  
                  <% if (locals.user && (user._id.toString() === review.user._id.toString() || user.isAdmin)) { %>
                    <div class="review-actions">
                      <button class="btn btn-sm btn-outline edit-review-btn" data-review-id="<%= review._id %>" data-rating="<%= review.rating %>" data-comment="<%= review.comment %>">
                        <i class="fas fa-edit"></i> Edit
                      </button>
                      <a href="/reviews/delete/<%= review._id %>" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this review?')">
                        <i class="fas fa-trash"></i> Delete
                      </a>
                    </div>
                  <% } %>
                </div>
              <% }); %>
            </div>
          <% } %>
          
          <% if (locals.user && hasPurchased && !hasReviewed) { %>
            <div class="add-review">
              <h3>Add Your Review</h3>
              <form action="/reviews/add" method="POST">
                <input type="hidden" name="productId" value="<%= product._id %>">
                
                <div class="form-group">
                  <label>Rating:</label>
                  <div class="rating-select">
                    <% for (let i = 5; i >= 1; i--) { %>
                      <input type="radio" name="rating" id="star<%= i %>" value="<%= i %>" <%= i === 5 ? 'checked' : '' %>>
                      <label for="star<%= i %>"><i class="fas fa-star"></i></label>
                    <% } %>
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="comment">Review:</label>
                  <textarea name="comment" id="comment" rows="4" required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">Submit Review</button>
              </form>
            </div>
          <% } else if (locals.user && !hasPurchased) { %>
            <div class="review-notice">
              <p>You need to purchase this product before you can leave a review.</p>
            </div>
          <% } else if (!locals.user) { %>
            <div class="review-notice">
              <p>Please <a href="/auth/login">log in</a> to leave a review.</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Edit Review Modal -->
  <div id="editReviewModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Edit Your Review</h2>
      <form action="/reviews/update" method="POST">
        <input type="hidden" name="reviewId" id="edit-review-id">
        <input type="hidden" name="productId" value="<%= product._id %>">
        
        <div class="form-group">
          <label>Rating:</label>
          <div class="rating-select">
            <% for (let i = 5; i >= 1; i--) { %>
              <input type="radio" name="rating" id="edit-star<%= i %>" value="<%= i %>">
              <label for="edit-star<%= i %>"><i class="fas fa-star"></i></label>
            <% } %>
          </div>
        </div>
        
        <div class="form-group">
          <label for="edit-comment">Review:</label>
          <textarea name="comment" id="edit-comment" rows="4" required></textarea>
        </div>
        
        <button type="submit" class="btn btn-primary">Update Review</button>
      </form>
    </div>
  </div>
  
  <script>
    // Quantity control
    document.querySelector('.qty-btn.minus').addEventListener('click', function() {
      const input = document.getElementById('quantity');
      const value = parseInt(input.value);
      if (value > 1) {
        input.value = value - 1;
      }
    });
    
    document.querySelector('.qty-btn.plus').addEventListener('click', function() {
      const input = document.getElementById('quantity');
      const value = parseInt(input.value);
      const max = parseInt(input.getAttribute('max'));
      if (value < max) {
        input.value = value + 1;
      }
    });
    
    // Edit review modal
    const modal = document.getElementById('editReviewModal');
    const editButtons = document.querySelectorAll('.edit-review-btn');
    const closeBtn = document.querySelector('.modal .close');
    
    editButtons.forEach(button => {
      button.addEventListener('click', function() {
        const reviewId = this.getAttribute('data-review-id');
        const rating = this.getAttribute('data-rating');
        const comment = this.getAttribute('data-comment');
        
        document.getElementById('edit-review-id').value = reviewId;
        document.getElementById(`edit-star${rating}`).checked = true;
        document.getElementById('edit-comment').value = comment;
        
        modal.style.display = 'block';
      });
    });
    
    closeBtn.addEventListener('click', function() {
      modal.style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
  </script>